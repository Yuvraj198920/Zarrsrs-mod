cmake_minimum_required(VERSION 3.16)
project(zarr_srs_modifier VERSION 1.0.0 LANGUAGES CXX)

# Set C++ standard (C++17 for GDAL 3.9+)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Find GDAL
find_package(GDAL CONFIG REQUIRED)
if(NOT GDAL_FOUND)
    find_package(GDAL REQUIRED)
endif()

# Include directories
include_directories(include)

# Source files
set(PLUGIN_SOURCES
    src/zarr_srs_modifier_dataset.cpp
    src/plugin_registration.cpp
)

# Create the plugin library
add_library(gdal_zarr_srs_modifier SHARED ${PLUGIN_SOURCES})

# Link against GDAL
target_link_libraries(gdal_zarr_srs_modifier PRIVATE GDAL::GDAL)

# Set plugin properties
set_target_properties(gdal_zarr_srs_modifier PROPERTIES
    PREFIX ""
    OUTPUT_NAME "gdal_zarr_srs_modifier"
)

# Install plugin
if(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
    execute_process(
        COMMAND gdal-config --prefix
        OUTPUT_VARIABLE GDAL_PREFIX
        OUTPUT_STRIP_TRAILING_WHITESPACE
        ERROR_QUIET
    )
    if(GDAL_PREFIX)
        set(PLUGIN_INSTALL_DIR "${GDAL_PREFIX}/lib/gdalplugins")
    else()
        set(PLUGIN_INSTALL_DIR "${CMAKE_INSTALL_PREFIX}/lib/gdalplugins")
    endif()
else()
    set(PLUGIN_INSTALL_DIR "${CMAKE_INSTALL_PREFIX}/lib/gdalplugins")
endif()

install(TARGETS gdal_zarr_srs_modifier
    LIBRARY DESTINATION ${PLUGIN_INSTALL_DIR}
    RUNTIME DESTINATION ${PLUGIN_INSTALL_DIR}
)